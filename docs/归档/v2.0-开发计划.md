# TimeTracker v2.0 迭代开发计划

---

## 元信息

- **计划版本**：v1.0
- **创建时间**：2026-01-02
- **目标版本**：v2.0（左右分栏 + 实时计时）
- **预计工期**：核心功能开发
- **基线版本**：v1.0（表单式录入）

---

## 一、需求对比分析

### v1.0 当前实现（表单式录入）

**布局结构**：
```
┌─────────────────────────────────────┐
│ [侧边栏导航]  时间段录入             │
│ - 录入        日期: [2026-01-02] ▼  │
│ - 分析        ─────────────────────  │
│ - 设置        新增记录               │
│               [开始] [结束] [事项]   │
│               [分类▼]     [保存]     │
│               ─────────────────────  │
│               今日记录 (总: 8.5h)    │
│               ┌──────────────────┐   │
│               │ 09:00-10:30 开会 │   │
│               │ 工作 1.5h [✏️][🗑️]│   │
│               └──────────────────┘   │
└─────────────────────────────────────┘
```

**核心特征**：
- ✅ 手动输入开始/结束时间
- ✅ 表单验证（Zod schema）
- ✅ 时间冲突检测（SQL 查询）
- ✅ 自动补全历史事项
- ✅ 内联编辑 + 删除撤销
- ✅ 日期导航器
- ✅ IPC 通信完整（CRUD + 冲突检测）
- ❌ 无实时计时功能
- ❌ 无计时器 UI
- ❌ 布局为垂直堆叠（非左右分栏）

---

### v2.0 目标架构（计时器 + 左右分栏）

**布局结构**：
```
┌────────────────────────────────────────────────────────┐
│  TimeTracker                          [设置] [统计]    │
├──────────────────────┬─────────────────────────────────┤
│                      │  📅 日期导航                     │
│   ⏱️ 计时主区         │  [ < ]  2026-01-02  [ > ]      │
│                      ├─────────────────────────────────┤
│   [圆形计时器]        │  📊 今日统计                     │
│     00:00            │  总时长: 0h  |  记录数: 0 条    │
│                      ├─────────────────────────────────┤
│   [事项输入框]        │  📝 今日记录                     │
│   今天在做什么...     │  ┌───────────────────────────┐ │
│                      │  │ 18:00-19:30 ● 晚餐       │ │
│   [分类选择器]        │  │ 生活  1.5h   [✏️] [🗑️]   │ │
│   🔵 工作 ▼          │  ├───────────────────────────┤ │
│                      │  │ 16:00-18:00 ● 写代码     │ │
│   [开始按钮]          │  │ 工作  2.0h   [✏️] [🗑️]   │ │
│                      │  └───────────────────────────┘ │
│                      │  [+ 手动添加时间段]              │
└──────────────────────┴─────────────────────────────────┘
```

**核心变更**：
1. **布局革新**：从垂直堆叠改为左右分栏（左 480px + 右自适应）
2. **交互升级**：新增实时计时模式（保留手动录入）
3. **计时器组件**：圆形计时器 + 动画效果 + 精度控制
4. **右侧重构**：日期导航 + 统计卡片 + 记录列表三段式
5. **快捷键增强**：空格开始/暂停，Enter 结束，数字键选分类
6. **响应式设计**：< 900px 时右侧收起为抽屉

---

## 二、架构影响分析

### 2.1 组件层级变化

**v1.0 组件树**：
```
EntryPage
├── DateNavigator（顶部）
├── TimeEntryForm（中部）
│   ├── TimeInput（开始时间）
│   ├── TimeInput（结束时间）
│   ├── ActivityAutocomplete
│   ├── CategorySelect
│   └── Button（保存）
└── TimeEntryList（底部）
    └── TimeEntryListItem[]
```

**v2.0 目标组件树**（推荐结构）：
```
EntryPage（新布局容器）
├── TimerPanel（左侧 480px）                    【新增】
│   ├── CircularTimer                          【新增】
│   ├── ActivityInput（带自动补全）             【改造】
│   ├── CategorySelect（快捷键增强）            【增强】
│   └── TimerControls（开始/暂停/结束）         【新增】
│       └── Button（状态切换）
└── RecordsSidebar（右侧自适应）                【新增】
    ├── DateNavigator（移至此处）              【移动】
    ├── DailyStatsCard（新增统计卡片）         【新增】
    ├── TimeEntryList（改造样式）              【改造】
    │   └── TimeEntryListItem[]
    └── ManualEntryModal（手动添加弹窗）        【新增】
```

### 2.2 状态管理扩展

**新增 Store**：
```typescript
// src/renderer/src/store/timerStore.ts【新增】
interface TimerStore {
  // 计时器状态
  isRunning: boolean
  isPaused: boolean
  startTime: number | null        // 时间戳
  pausedTime: number | null
  elapsedSeconds: number

  // 草稿数据
  draftActivity: string
  draftCategoryId: number | null

  // 操作方法
  startTimer: () => void
  pauseTimer: () => void
  resumeTimer: () => void
  stopTimer: () => void
  updateDraft: (field: string, value: any) => void
  clearTimer: () => void

  // 持久化恢复（LocalStorage）
  restoreFromCache: () => void
  saveToCache: () => void
}
```

**复用现有 Store**：
- `timeEntriesStore`：保持不变（CRUD 操作）
- `categoriesStore`：保持不变（分类管理）

### 2.3 IPC 接口复用度

**✅ 无需新增 IPC 方法**（现有接口完全满足）：
- `timeEntries:create` - 计时器结束后保存
- `timeEntries:checkConflict` - 计时结束前检测冲突
- `activities:search` - 事项自动补全
- `categories:getAll` - 加载分类列表
- `timeEntries:getByDate` - 右侧列表加载

**后端无改动**：v2.0 的所有变更集中在前端 UI 层。

---

## 三、开发任务拆解

### 阶段一：基础布局改造（核心变更） ✅ 已完成

#### 任务 1.1：创建左右分栏布局容器 ✅
**文件**：`src/renderer/src/pages/EntryPage.tsx`

**改造内容**：
```tsx
// 当前：垂直堆叠布局
<div className="p-6">
  <DateNavigator />
  <TimeEntryForm />
  <TimeEntryList />
</div>

// v2.0：左右分栏布局
<div className="flex h-screen">
  <TimerPanel className="w-[480px] flex-shrink-0" />
  <RecordsSidebar className="flex-1 min-w-[420px]" />
</div>
```

**响应式处理**：
- 使用 Tailwind 断点：`lg:flex`（≥ 1024px 显示分栏）
- 移动端（< 1024px）：隐藏右侧，改为底部抽屉（可选）

**验收标准**：
- [x] 左侧固定 480px，右侧自适应
- [x] 最小窗口宽度 900px（低于此宽度时右侧隐藏）
- [x] 布局无滚动条（内部区域独立滚动）

---

#### 任务 1.2：开发左侧计时主区组件 ✅

##### 1.2.1 圆形计时器组件 ✅
**文件**：`src/renderer/src/components/entry/CircularTimer.tsx`【新增】

**技术方案**：
```tsx
interface CircularTimerProps {
  elapsedSeconds: number
  isRunning: boolean
  onClick: () => void  // 点击计时器本身 = 开始/暂停
}

// 视觉实现：
// - 使用 SVG <circle> 绘制圆环
// - stroke-dasharray + stroke-dashoffset 实现进度动画
// - conic-gradient 渐变色（蓝色渐变）
// - 数字字体：text-7xl font-bold（Tailwind）
```

**核心逻辑**：
- 每秒更新 `elapsedSeconds`（通过 `setInterval` 驱动 UI）
- 实际时长计算：`Math.floor((Date.now() - startTime) / 1000)`（避免累计误差）
- 动画：`transition-all duration-1000 ease-linear`

**验收标准**：
- [x] 计时中：蓝色渐变动画顺时针填充
- [x] 暂停：灰色静态圆环
- [x] 点击计时器 = 开始/暂停
- [x] 字号 72px（易读性强）
- [x] 精度：显示到秒（HH:MM:SS 或 MM:SS）

---

##### 1.2.2 计时器面板容器 ✅
**文件**：`src/renderer/src/components/entry/TimerPanel.tsx`【新增】

**组件结构**：
```tsx
export function TimerPanel() {
  const { isRunning, elapsedSeconds, startTimer, pauseTimer } = useTimerStore()

  return (
    <div className="flex flex-col items-center justify-center p-8 bg-gray-50">
      <CircularTimer
        elapsedSeconds={elapsedSeconds}
        isRunning={isRunning}
        onClick={isRunning ? pauseTimer : startTimer}
      />

      <ActivityInput className="mt-8 w-full max-w-xs" />
      <CategorySelect className="mt-4 w-full max-w-xs" />

      <TimerControls className="mt-6" />
    </div>
  )
}
```

**验收标准**：
- [x] 居中布局，视觉焦点在计时器
- [x] 组件垂直排列，间距合理
- [x] 宽度固定 480px

---

##### 1.2.3 事项输入框（改造） ✅
**文件**：`src/renderer/src/components/entry/ActivityInput.tsx`【新增】

**改造内容**：
- 基于现有 `ActivityAutocomplete` 改造
- 新增：草稿自动保存（LocalStorage）
- 新增：`Cmd+I` 快捷键聚焦
- 占位符：\"今天在做什么...\"
- 支持**计时中/计时后**随时输入

**复用逻辑**：
- `activities:search` IPC 查询历史事项
- Debounce 300ms
- 键盘导航：↑↓ 选择，Enter 确认

**验收标准**：
- [x] 输入时触发自动补全
- [x] 下拉列表最多显示 10 条
- [x] 按使用频率排序
- [x] `Cmd+I` 聚焦输入框
- [x] 草稿缓存（刷新后恢复）

---

##### 1.2.4 分类选择器（增强） ✅
**文件**：`src/renderer/src/components/entry/CategorySelect.tsx`【增强】

**新增功能**：
- 数字键快捷选择：`1/2/3/4` 对应前 4 个分类
- 默认选中\"最近使用\"的分类（基于上一次录入）
- 彩色图标显示（圆点 + 颜色）

**技术实现**：
```tsx
useEffect(() => {
  const handleKeyPress = (e: KeyboardEvent) => {
    if (e.key >= '1' && e.key <= '4') {
      const index = parseInt(e.key) - 1
      if (categories[index]) {
        selectCategory(categories[index].id)
      }
    }
  }
  window.addEventListener('keydown', handleKeyPress)
  return () => window.removeEventListener('keydown', handleKeyPress)
}, [categories])
```

**验收标准**：
- [x] 数字键 1/2/3 快速选择
- [x] 显示彩色圆点标识
- [x] 默认选中上次使用的分类

---

##### 1.2.5 计时器控制按钮 ✅
**文件**：`src/renderer/src/components/entry/TimerControls.tsx`【新增】

**状态切换逻辑**：
```
未计时 → 点击\"开始\" → 计时中
计时中 → 点击\"暂停\" → 已暂停
已暂停 → 点击\"继续\" OR \"结束\"
```

**快捷键**：
- `Space` 空格 = 开始/暂停
- `Enter` 回车 = 结束并保存
- `Esc` = 取消计时（弹窗确认）

**结束计时流程**：
1. 校验事项名称（若为空则聚焦到输入框）
2. 调用 `timeEntries:checkConflict`
3. 弹出冲突提示（若有）
4. 调用 `timeEntries:create` 保存
5. 清空表单 + 计时器归零
6. Toast 提示\"保存成功\"

**验收标准**：
- [x] 按钮状态正确切换（开始/暂停/继续|结束）
- [x] 快捷键响应正常
- [x] 结束时校验必填字段
- [x] 保存成功后清空表单

---

#### 任务 1.3：开发右侧上下文信息区 ✅

##### 1.3.1 记录侧边栏容器 ✅
**文件**：`src/renderer/src/components/entry/RecordsSidebar.tsx`【新增】

**组件结构**：
```tsx
export function RecordsSidebar() {
  return (
    <div className="flex flex-col h-full bg-white border-l">
      <DateNavigator className="p-4 border-b" />
      <DailyStatsCard className="p-4 bg-gray-50" />
      <TimeEntryList className="flex-1 overflow-y-auto p-4" />
      <ManualEntryButton className="p-4 border-t" />
    </div>
  )
}
```

**验收标准**：
- [x] 三段式布局（日期 + 统计 + 列表）
- [x] 列表区域独立滚动
- [x] 手动添加按钮固定在底部

---

##### 1.3.2 日期导航栏（移动） ✅
**文件**：`src/renderer/src/components/entry/DateNavigator.tsx`【改造】

**改造内容**：
- 从 EntryPage 顶部移至 RecordsSidebar 顶部
- 样式调整：`[ < ]  2026-01-02 (今日)  [ > ]`
- 新增快捷键：`Cmd+←` 前一天，`Cmd+→` 后一天，`Cmd+D` 回到今天

**重要逻辑**：
- 切换日期**仅影响右侧列表**，不影响左侧计时器
- 左侧计时器**始终保存到今天**

**验收标准**：
- [x] 位置移至右侧顶部
- [x] 快捷键响应正常
- [x] 今天显示\"(今日)\"标签
- [x] 右箭头在今天时置灰

---

##### 1.3.3 今日统计卡片 ✅
**文件**：`src/renderer/src/components/entry/DailyStatsCard.tsx`【新增】

**显示内容**：
```
总时长: 8.5 小时  |  记录数: 12 条
```

**数据来源**：
- 从 `timeEntriesStore.entries` 实时计算
- `totalDuration = entries.reduce((sum, e) => sum + e.duration_minutes, 0)`
- `entryCount = entries.length`

**格式化**：
- 时长 ≥ 60min：显示 `X.Xh`（如 8.5h）
- 时长 < 60min：显示 `XXm`（如 45m）

**验收标准**：
- [x] 实时更新（新增/编辑/删除后刷新）
- [x] 格式正确（小时/分钟）
- [x] 样式：浅灰背景，数字加粗

---

##### 1.3.4 记录列表（改造样式） ✅
**文件**：`src/renderer/src/components/entry/TimeEntryList.tsx`【改造】

**样式改造**：
```tsx
// v1.0：单行展示
<div className="flex items-center justify-between">
  <span>09:00 - 10:30  工作  开会  1.5h</span>
  <div>[✏️] [🗑️]</div>
</div>

// v2.0：两行展示
<div className="p-3 hover:bg-gray-50">
  <div className="flex items-center gap-2">
    <span className="text-gray-500">18:00 - 19:30</span>
    <span className="w-2 h-2 rounded-full bg-green-500"></span> {/* 分类圆点 */}
    <span className="font-semibold">晚餐</span>
  </div>
  <div className="flex items-center justify-between mt-1">
    <span className="text-sm text-gray-500">生活  1.5h</span>
    <div className="opacity-0 group-hover:opacity-100">
      [✏️] [🗑️]
    </div>
  </div>
</div>
```

**新增空状态**：
```tsx
{entries.length === 0 && (
  <div className="text-center py-12">
    <p className="text-gray-400">📭 今天还没有记录</p>
    <Button className="mt-4" onClick={focusTimer}>开始第一次计时</Button>
  </div>
)}
```

**验收标准**：
- [x] 两行布局（时间段+事项 / 分类+时长+操作）
- [x] 悬浮显示编辑/删除按钮
- [x] 分类彩色圆点显示
- [x] 空状态引导点击

---

##### 1.3.5 手动添加时间段弹窗 ✅
**文件**：`src/renderer/src/components/entry/ManualEntryModal.tsx`【新增】

**触发方式**：
- 点击底部 `[+ 手动添加时间段]` 按钮
- 快捷键：`Cmd+N`

**表单字段**：
- 日期选择器（默认右侧当前选中日期）
- 开始时间（TimeInput，支持 HH:MM 或 HHMM）
- 结束时间（同上）
- 事项名称（ActivityAutocomplete）
- 分类选择（CategorySelect）
- [取消] [保存] 按钮

**复用组件**：
- `TimeInput`（来自 v1.0）
- `ActivityAutocomplete`（复用自动补全）
- `CategorySelect`（增强版）

**校验逻辑**：
- 同计时器结束保存逻辑
- 冲突检测 + 确认覆盖

**验收标准**：
- [x] 模态窗口居中显示
- [x] 表单字段校验正常
- [x] 保存成功后关闭弹窗并刷新列表
- [x] `Cmd+N` 快捷键打开

---

### 阶段二：计时器核心逻辑开发 ✅ 已完成

#### 任务 2.1：创建计时器状态管理 ✅
**文件**：`src/renderer/src/store/timerStore.ts`【新增】

**状态设计**：
```typescript
interface TimerStore {
  // 计时状态
  isRunning: boolean
  isPaused: boolean
  startTime: number | null        // Date.now() 时间戳
  pausedTime: number | null
  elapsedSeconds: number          // UI 显示用

  // 草稿数据
  draftActivity: string
  draftCategoryId: number | null

  // 方法
  startTimer: () => void
  pauseTimer: () => void
  resumeTimer: () => void
  stopTimer: () => void
  setElapsedSeconds: (seconds: number) => void
  updateDraft: (field, value) => void
  clearTimer: () => void
}
```

**精度控制**：
- 使用 `Date.now()` 记录开始时间戳
- UI 更新通过 `setInterval(1000)` 驱动
- 实际时长计算：`Math.floor((Date.now() - startTime) / 1000)`

**持久化**：
- 计时器状态保存到 `localStorage`（应用重启后恢复）
- Key: `timer-storage`
- 存储字段：`isRunning`, `isPaused`, `startTime`, `pausedTime`, `draftActivity`, `draftCategoryId`

**验收标准**：
- [x] 开始/暂停/恢复状态切换正常
- [x] 计时精度准确（无累计误差）
- [x] 刷新页面后计时器恢复（如果计时中）
- [x] 草稿数据持久化

---

#### 任务 2.2：后台计时与休眠处理（可选，MVP 阶段建议后置） ⏭️ 跳过
**说明**：根据 MVP 策略，当前版本优先保证核心计时功能。利用时间戳差值计算已天然支持后台计时（应用最小化时），系统休眠检测留待后续迭代。

---

#### 任务 2.3：计时器 UI 更新循环 ✅
**文件**：`src/renderer/src/hooks/useTimerTick.ts`【新增】

**技术方案**：
```typescript
export function useTimerTick() {
  const { isRunning, isPaused, startTime, pausedTime, setElapsedSeconds } = useTimerStore()

  useEffect(() => {
    // 自动恢复正确的 elapsedSeconds（包括刷新页面后）
    const updateElapsed = () => { /* ... */ }
    updateElapsed()

    let interval: NodeJS.Timeout
    if (isRunning) {
      interval = setInterval(updateElapsed, 1000)
    }
    return () => clearInterval(interval)
  }, [isRunning, isPaused, startTime, pausedTime])
}
```

**验收标准**：
- [x] 计时中每秒更新 UI
- [x] 暂停时停止更新
- [x] 恢复时继续累计
- [x] CPU 占用 < 1%

---

### 阶段三：交互优化与细节打磨 ✅ 已完成

#### 任务 3.1：全局快捷键系统 ✅
**文件**：`src/renderer/src/hooks/useGlobalShortcuts.ts`【新增】

**快捷键清单**：
| 快捷键 | 功能 | 作用域 |
|--------|------|--------|
| `Space` | 开始/暂停计时 | 全局 |
| `Enter` | 结束并保存 | 计时中 |
| `Esc` | 取消计时 | 计时中 |
| `Cmd+I` | 聚焦事项输入框 | 全局 |
| `1/2/3` | 快速选择分类 | 全局 |
| `Cmd+N` | 打开手动添加弹窗 | 全局 |
| `Cmd+←` | 前一天 | 全局 |
| `Cmd+→` | 后一天 | 全局 |
| `Cmd+D` | 回到今天 | 全局 |

**技术实现**：
```typescript
useEffect(() => {
  const handleKeyDown = (e: KeyboardEvent) => {
    // 避免与输入框冲突
    if (e.target instanceof HTMLInputElement) return

    if (e.key === ' ') {
      e.preventDefault()
      timerStore.isRunning ? pauseTimer() : startTimer()
    }
    // ... 其他快捷键
  }
  window.addEventListener('keydown', handleKeyDown)
  return () => window.removeEventListener('keydown', handleKeyDown)
}, [])
```

**验收标准**：
- [x] 所有快捷键响应正常
- [x] 不与系统快捷键冲突
- [x] 输入框聚焦时空格键不触发计时器

---

#### 任务 3.2：冲突检测与提示优化 ✅
**文件**：`src/renderer/src/components/entry/ConflictDialog.tsx`【增强】

**改造内容**：
- 计时器结束保存时调用 `timeEntries:checkConflict`
- 若有冲突，弹出提示对话框（包含冲突详情）
- 点击\"覆盖保存\"继续保存（不阻止）

**验收标准**：
- [x] 冲突检测查询 < 50ms
- [x] 对话框样式清晰
- [x] 用户可选择覆盖或取消

---

#### 任务 3.3：Toast 通知系统 ✅
**文件**：`react-hot-toast` (Integrated)

**使用场景**：
- 保存成功：\"保存成功\"
- 删除记录：\"已删除 [撤销]\"
- 冲突警告：弹窗提示
- 系统错误：Toast 错误提示

**验收标准**：
- [x] Toast 位置合理（右上角）
- [x] 自动消失时间正确
- [x] 撤销功能正常

---

#### 任务 3.4：响应式布局适配 ✅
**文件**：`src/renderer/src/pages/EntryPage.tsx`

**断点设计**：
- `≥ 900px`：左右分栏完整显示
- `< 900px`：右侧隐藏，显示菜单按钮，点击展开侧边栏（Drawer）

**技术方案**：
```tsx
const [isMobile, setIsMobile] = useState(window.innerWidth < 900)
// ...
return isMobile ? (
  <Sheet>
    <SheetTrigger><Menu /></SheetTrigger>
    <SheetContent><RecordsSidebar /></SheetContent>
  </Sheet>
) : (
  <DesktopLayout />
)
```

**验收标准**：
- [x] 窗口缩放时布局自动切换
- [x] 最小宽度 900px 时功能完整可用
- [x] 移动端模式下计时器优先显示

---

### 阶段四：兼容性与测试

#### 任务 4.1：数据兼容性测试
**测试目标**：
- v1.0 数据库无缝迁移到 v2.0（无需改表结构）
- 现有记录正常显示
- 新增的计时器记录与手动录入记录格式一致

**验收标准**：
- [ ] 升级后现有数据完整无损
- [ ] 计时器保存的记录可被编辑/删除
- [ ] 分析页面数据展示正常

---

#### 任务 4.2：性能压力测试
**测试场景**：
1. 加载 1000 条记录（右侧列表滚动流畅度）
2. 计时器连续运行 8 小时（CPU 占用 < 1%）
3. 频繁切换日期（< 100ms 响应）
4. 快速连续录入 50 条记录（无卡顿）

**验收标准**：
- [ ] 所有场景性能达标
- [ ] 无内存泄漏
- [ ] 长时间运行稳定

---

#### 任务 4.3：用户体验测试
**测试清单**：
- [ ] 实时计时：从坐下到开始计时 < 2 秒
- [ ] 手动补录：单次录入（含思考）< 5 秒
- [ ] 所有操作可纯键盘完成
- [ ] 错误提示友好（无技术术语）
- [ ] 界面响应即时（无卡顿感）

---

## 四、文件清单

### 新增文件（18 个）

**组件层**（12 个）：
1. `src/renderer/src/components/entry/TimerPanel.tsx` - 左侧计时主区容器
2. `src/renderer/src/components/entry/CircularTimer.tsx` - 圆形计时器
3. `src/renderer/src/components/entry/ActivityInput.tsx` - 事项输入框（改造）
4. `src/renderer/src/components/entry/TimerControls.tsx` - 计时器控制按钮
5. `src/renderer/src/components/entry/RecordsSidebar.tsx` - 右侧侧边栏容器
6. `src/renderer/src/components/entry/DailyStatsCard.tsx` - 今日统计卡片
7. `src/renderer/src/components/entry/ManualEntryModal.tsx` - 手动添加弹窗
8. `src/renderer/src/components/entry/ManualEntryButton.tsx` - 手动添加按钮
9. `src/renderer/src/components/entry/EmptyState.tsx` - 空状态组件
10. `src/renderer/src/components/entry/SleepDialog.tsx` - 休眠时长确认对话框（可选）

**状态管理**（1 个）：
11. `src/renderer/src/store/timerStore.ts` - 计时器状态管理

**Hooks**（3 个）：
12. `src/renderer/src/hooks/useTimerTick.ts` - 计时器 UI 更新
13. `src/renderer/src/hooks/useGlobalShortcuts.ts` - 全局快捷键
14. `src/renderer/src/hooks/useSystemEvents.ts` - 系统事件监听（可选）

**工具函数**（2 个）：
15. `src/renderer/src/lib/timerUtils.ts` - 计时器工具函数（格式化时长等）
16. `src/renderer/src/lib/localStorageCache.ts` - LocalStorage 缓存管理

### 改造文件（7 个）

1. `src/renderer/src/pages/EntryPage.tsx` - 布局从垂直改为左右分栏
2. `src/renderer/src/components/entry/CategorySelect.tsx` - 新增数字键快捷选择
3. `src/renderer/src/components/entry/DateNavigator.tsx` - 移至右侧 + 新增快捷键
4. `src/renderer/src/components/entry/TimeEntryList.tsx` - 样式改为两行布局
5. `src/renderer/src/components/entry/TimeEntryListItem.tsx` - 样式调整
6. `src/renderer/src/components/entry/ConflictDialog.tsx` - 增强冲突提示
7. `src/main/index.ts` - 新增系统事件监听（可选）

### 复用文件（无需改动）

1. `src/renderer/src/components/entry/TimeInput.tsx` - 时间输入框
2. `src/renderer/src/components/entry/ActivityAutocomplete.tsx` - 事项自动补全
3. `src/renderer/src/components/entry/DeleteConfirmDialog.tsx` - 删除确认
4. `src/renderer/src/store/timeEntriesStore.ts` - 时间段记录状态
5. `src/renderer/src/store/categoriesStore.ts` - 分类状态
6. `src/renderer/src/lib/api.ts` - IPC API 封装
7. `src/main/ipc/handlers/timeEntries.ts` - 时间段 IPC 处理
8. `src/main/ipc/handlers/categories.ts` - 分类 IPC 处理
9. `src/main/database/index.ts` - SQLite 数据库

---

## 五、风险评估

### 技术风险

**风险 1：计时器精度问题**
- **描述**：`setInterval` 累计误差导致计时不准
- **缓解**：使用时间戳差值计算真实时长
- **影响**：低（已有成熟方案）

**风险 2：系统休眠处理复杂度**
- **描述**：Electron `powerMonitor` 事件在某些 macOS 版本不稳定
- **缓解**：MVP 阶段可选实现，优先保证基础计时功能
- **影响**：中（可后置）

**风险 3：响应式布局兼容性**
- **描述**：不同屏幕尺寸下布局可能错乱
- **缓解**：Tailwind 断点 + 充分测试
- **影响**：低（Tailwind 成熟）

### 业务风险

**风险 4：用户习惯迁移成本**
- **描述**：从表单式改为计时器模式，用户需要适应
- **缓解**：保留手动添加入口，两种模式并存
- **影响**：低（提供降级方案）

**风险 5：数据迁移兼容性**
- **描述**：v1.0 数据可能在 v2.0 中显示异常
- **缓解**：数据库表结构无改动，仅 UI 层变化
- **影响**：极低（无需迁移脚本）

---

## 六、验收标准总览

### 功能完整性
- [ ] 左侧计时器：开始/暂停/继续/结束流程完整
- [ ] 右侧信息区：日期导航 + 统计 + 列表三段式布局
- [ ] 手动添加：弹窗表单可正常录入
- [ ] 编辑/删除：功能正常，撤销机制有效
- [ ] 自动补全：事项/分类智能推荐
- [ ] 冲突检测：实时提示，可覆盖保存
- [ ] 快捷键：全局快捷键响应正常

### 性能指标
- [ ] 计时器更新：每秒刷新，CPU < 1%
- [ ] 录入响应：提交 < 200ms
- [ ] 列表加载：切换日期 < 100ms
- [ ] 冲突检测：查询 < 50ms
- [ ] 自动补全：搜索 < 300ms

### 用户体验
- [ ] 实时计时：启动 < 2 秒
- [ ] 手动补录：单次 < 5 秒
- [ ] 纯键盘操作：所有核心功能可用
- [ ] 视觉反馈：即时响应，无卡顿
- [ ] 错误提示：清晰友好

### 兼容性
- [ ] 数据兼容：v1.0 数据正常显示
- [ ] 响应式：≥ 900px 完整显示，< 900px 降级方案
- [ ] macOS 版本：支持 macOS 11+ (Big Sur)

---

## 七、开发建议

### 优先级划分

**P0（核心必做）**：
1. 左右分栏布局改造
2. 圆形计时器组件
3. 计时器状态管理（timerStore）
4. 右侧三段式布局
5. 手动添加弹窗
6. 全局快捷键系统

**P1（重要）**：
7. 事项输入框自动补全优化
8. 分类选择器数字键增强
9. 记录列表样式改造
10. Toast 通知优化
11. 冲突检测提示增强

**P2（可选）**：
12. 系统休眠处理
13. 响应式移动端抽屉
14. 计时器动画优化
15. 空状态引导

### 开发顺序建议

**第 1 天**：
- 创建 TimerPanel + CircularTimer 组件
- 实现 timerStore 基础状态管理
- 完成计时器 UI（静态）

**第 2 天**：
- 实现计时器核心逻辑（开始/暂停/恢复）
- 开发 useTimerTick Hook
- 测试计时精度

**第 3 天**：
- 改造 EntryPage 为左右分栏布局
- 开发 RecordsSidebar 容器
- 移动 DateNavigator 到右侧

**第 4 天**：
- 开发 DailyStatsCard 统计卡片
- 改造 TimeEntryList 为两行布局
- 开发 ManualEntryModal 弹窗

**第 5 天**：
- 实现全局快捷键系统
- 开发 TimerControls 控制按钮
- 实现结束保存流程（含冲突检测）

**第 6 天**：
- 事项输入框自动补全改造
- 分类选择器数字键增强
- Toast 通知系统集成

**第 7 天**：
- 响应式布局适配
- 空状态设计
- 细节打磨

**第 8 天**：
- 完整功能测试
- 性能压力测试
- 用户体验测试

### 技术难点攻克

**难点 1：计时器精度控制**
```typescript
// 正确方案：使用时间戳差值
const startTime = Date.now()
setInterval(() => {
  const elapsed = Math.floor((Date.now() - startTime) / 1000)
  setElapsedSeconds(elapsed)
}, 1000)

// 错误方案：累加秒数（会有累计误差）
let seconds = 0
setInterval(() => {
  seconds += 1  // ❌ 误差会累计
}, 1000)
```

**难点 2：全局快捷键与输入框冲突**
```typescript
const handleKeyDown = (e: KeyboardEvent) => {
  // 输入框聚焦时不响应全局快捷键
  if (e.target instanceof HTMLInputElement ||
      e.target instanceof HTMLTextAreaElement) {
    return
  }

  // 处理全局快捷键
  if (e.key === ' ') {
    e.preventDefault()
    toggleTimer()
  }
}
```

**难点 3：右侧日期切换不影响左侧计时器**
```typescript
// timerStore 始终保存到今天
const stopAndSave = async () => {
  const today = format(new Date(), 'yyyy-MM-dd')  // 固定为今天
  await api.createTimeEntry({
    date: today,  // 不受 timeEntriesStore.selectedDate 影响
    startTime: ...,
    endTime: ...,
    activity: draftActivity,
    categoryId: draftCategoryId
  })
}

// 右侧列表加载基于 selectedDate
const entries = await api.getTimeEntriesByDate(selectedDate)
```

---

## 八、附录

### A. 参考文档
- [mvp-time-entry.md v2.0](docs/requirements/mvp-time-entry.md) - 需求文档
- [CLAUDE.md](CLAUDE.md) - 项目规则
- [database-design.md](docs/database-design.md) - 数据库设计
- [blueprint.md](docs/blueprint.md) - 项目蓝图

### B. 技术栈文档
- [Zustand 文档](https://github.com/pmndrs/zustand)
- [Tailwind CSS 断点](https://tailwindcss.com/docs/responsive-design)
- [Electron powerMonitor](https://www.electronjs.org/docs/latest/api/power-monitor)
- [react-hook-form](https://react-hook-form.com/)

### C. UI 参考
- Apple Watch 活动圆环动画
- Toggl Track 计时器交互
- RescueTime 时间统计卡片

---

**计划版本**：v1.0
**创建时间**：2026-01-02
**预计完成时间**：根据实际开发节奏调整
**核心目标**：从表单式录入升级为计时器 + 左右分栏模式，提升录入效率至 < 2 秒启动计时