# 时间段录入功能（MVP 核心）

---

## 元信息

- **所属系统**：TimeTracker
- **所属模块**：数据录入模块
- **创建时间**：2026-01-02
- **最后更新**：2026-01-03
- **当前版本**：v3.0
- **状态**：规划中
- **负责人**：lok666

---

## 变更历史

| 日期 | 版本 | 变更类型 | 变更内容 | 影响文件 | 变更人 |
|------|------|----------|----------|----------|--------|
| 2026-01-03 | v3.0 | 重构 | 【核心架构变更】<br>1. 移除计时器（Timer）功能，改为"时间切分器"（Switch）模式<br>2. 新增"当前正在进行"状态展示（无秒级刷新）<br>3. 时间默认连续，通过"切换"操作自动结束上一条并开始新的<br>4. 新增多维标签选择器（替代单一分类字段）<br>5. 新增智能默认逻辑（基于事项名称回填维度选项）<br>6. 新增 Gap（空洞）检测与补录功能<br>7. 调整列表为"时间流"样式（从上到下时间轴） | 全部功能描述、UI 设计、技术实现 | lok666 |
| 2026-01-02 | v2.0 | 优化 | 调整页面布局为左右分栏结构（左侧计时器 + 右侧列表） | 功能描述(1.0-2.4)、技术实现、验收标准 | lok666 |
| 2026-01-02 | v1.0 | 新增 | 初始版本(表单式录入) | 全部 | lok666 |

---

## 业务背景

用户当前使用 Excel 手工记录时间支出，存在以下痛点：
1. **录入繁琐**：需要手动填写多列单元格，无法快速连续录入
2. **数据校验缺失**：时间格式错误、时间段冲突等问题需事后检查
3. **历史回溯困难**：查找往日记录需滚动大量行，效率低下
4. **无法自动补全**：重复事项需反复输入，无法利用历史数据
5. **分类维度固定**：Excel 列难以扩展，无法适应人生阶段变化（如新增"项目"、"质量"等维度）

**核心诉求**：将单次录入耗时从 Excel 的 15-20 秒缩短至 < 3 秒，通过"时间切分器" + 智能补全实现"丝滑切换"。

---

## 核心设计理念

### 1. 时间流隐喻（Time Stream）

**核心概念**：
- 时间是一条连续流动的河流，用户永远处于"正在做某事"的状态
- 不需要"停止"操作，只需要在事项切换时"切一刀"
- 系统自动保证时间的连续性（下一条的开始时间 = 上一条的结束时间）

**与传统计时器的对比**：
| 维度 | 传统计时器（Timer） | 时间切分器（Switch） |
|------|-------------------|---------------------|
| 心理模型 | 开始 → 焦虑地看秒表 → 停止 | 正在做 X → 切换到 Y |
| 操作步数 | 点击停止 + 输入事项 + 选分类 + 点击开始 | 输入事项 + 回车 |
| 界面特征 | 秒表跳动数字 | 静态状态展示 |
| 忘记操作后果 | 数据完全丢失 | 仅产生"空洞"，可补录 |

### 2. 多维标签系统

**设计原则**：
- 不再使用固定的"分类"字段，改为灵活的"维度-选项"体系
- 用户可以自定义任意数量的维度（如：领域、项目、质量、心情等）
- 每个维度下可配置多个选项（如："领域"下有"工作/学习/生活"）
- 支持维度的启用/禁用（适应人生阶段变化）

**示例**：
```
记录："写代码" 1.5 小时
标签：
  - [领域] 工作
  - [项目] TimeTracker
  - [质量] 高效
```

### 3. 智能默认机制

**核心逻辑**：基于事项名称记忆维度选项。

**场景示例**：
- 第1次输入"写代码"：手动选择 [工作, TimeTracker, 高效]
- 第2次输入"写代码"：系统自动回填上次的选项，用户只需回车确认

**匹配策略**：
1. **精确匹配**：输入"写代码"，匹配历史中最近一次"写代码"的维度选项
2. **模糊匹配**：输入"写代"，显示候选列表"写代码"、"写文档"
3. **新事项**：如果是全新输入，使用上一条记录的维度选项作为默认

---

## 功能描述

### 1. 整体布局结构

#### 1.1 主界面布局

```
┌────────────────────────────────────────────────────────┐
│ TimeTracker          📊 分析   ⚙️ 设置      [- □ ×]    │
├────────────────────────────────────────────────────────┤
│                                                        │
│  ┌──────────────────────────────────────────────┐    │
│  │ 正在进行：TimeTracker 开发                    │    │
│  │ 已持续：1h 23m                                │    │
│  │ [领域:工作 | 项目:TT | 质量:高效]            │    │
│  └──────────────────────────────────────────────┘    │
│                                                        │
│  ┌──────────────────────────────────────────────┐    │
│  │ [接下来要做什么？_______________]  (Cmd+K)   │    │
│  └──────────────────────────────────────────────┘    │
│                                                        │
│  ────────────────────────────────────────────────     │
│                                                        │
│  📅 今日记录 (2026-01-03)      [ < 今日 > ]           │
│                                                        │
│  ┌──────────────────────────────────────────────┐    │
│  │ 10:30 - Now   TimeTracker 开发   1h 23m      │    │
│  │ [工作 | TimeTracker | 高效]    [✏️] [🗑️]     │    │
│  ├──────────────────────────────────────────────┤    │
│  │ 09:00 - 10:30  需求评审         1h 30m       │    │
│  │ [工作 | CRM | 一般]             [✏️] [🗑️]     │    │
│  ├──────────────────────────────────────────────┤    │
│  │ 🚫 08:00 - 09:00 (1小时未记录) [点击补录]    │    │
│  ├──────────────────────────────────────────────┤    │
│  │ 07:00 - 08:00  早餐+通勤        1h 00m       │    │
│  │ [生活日常]                      [✏️] [🗑️]     │    │
│  └──────────────────────────────────────────────┘    │
│                                                        │
│  [ + 手动补录时间段 ]                                  │
│                                                        │
└────────────────────────────────────────────────────────┘
```

#### 1.2 布局规格

**最小窗口尺寸**：
- 宽度：800px
- 高度：600px

**响应式策略**：
- 宽度 < 800px：显示"窗口过小"提示，建议放大窗口
- 高度 < 600px：内容区域启用滚动

---

### 2. "当前正在进行"状态区

#### 2.1 视觉设计

**位置**：页面顶部，占据核心视觉焦点。

**内容结构**：
```
┌──────────────────────────────────────────────┐
│ 正在进行：【事项名称】                        │
│ 已持续：【时长】                              │
│ 【维度标签列表】                              │
└──────────────────────────────────────────────┘
```

**样式规范**：
- 背景色：浅蓝色渐变（#EFF6FF → #DBEAFE）
- 边框：1px 蓝色（#3B82F6）
- 圆角：12px
- 内边距：24px
- 阴影：轻微阴影（0 2px 8px rgba(0, 0, 0, 0.05)）

#### 2.2 内容显示

**事项名称**：
- 字号：24px
- 字重：Medium
- 颜色：#1E293B

**已持续时长**：
- 格式：`Xh Ym`（如：1h 23m）
- 字号：18px
- 颜色：#64748B
- 更新频率：每分钟刷新一次（无需秒级刷新）

**维度标签**：
- 展示方式：水平排列，用 `|` 分隔
- 格式：`[维度名:选项名]`
- 示例：`[领域:工作 | 项目:TimeTracker | 质量:高效]`
- 颜色：使用选项配置的颜色值

#### 2.3 交互行为

**点击事项名称**：
- 弹出编辑弹窗，可修改事项名称和维度选项
- 不改变时间（结束时间仍为空）

**点击时长**：
- 弹出时间调整弹窗，可手动修正开始时间
- 用于场景：忘记切换，需要回溯开始时间

**空状态**：
- 如果数据库中没有 `end_time` 为空的记录，显示：
  ```
  ┌──────────────────────────────────────────────┐
  │ 当前没有正在进行的事项                        │
  │ [ 开始新的一天 ]                             │
  └──────────────────────────────────────────────┘
  ```
- 点击"开始新的一天"按钮，弹出快速录入输入框

---

### 3. 快速切换输入框

#### 3.1 视觉设计

**位置**：紧跟在"当前正在进行"区域下方。

**样式规范**：
- 输入框宽度：100%
- 高度：48px
- 边框：2px 实线灰色（#D1D5DB），聚焦时变为蓝色（#3B82F6）
- 圆角：8px
- 占位符文字：`接下来要做什么？`（灰色 #9CA3AF）

**右侧提示**：
- 显示快捷键提示：`Cmd+K`
- 字号：12px
- 颜色：#64748B

#### 3.2 自动补全逻辑

**触发条件**：
- 用户输入 ≥ 2 个字符时开始匹配

**匹配策略**：
1. **精确匹配优先**：先查找完全匹配的事项名称
2. **前缀匹配**：如输入"写"，匹配"写代码"、"写文档"
3. **包含匹配**：如输入"代码"，匹配"写代码"、"调试代码"
4. **按使用频率排序**：最近使用的排在前面

**候选列表展示**：
```
┌──────────────────────────────────────────────┐
│ [接下来要做什么？写_______________]           │
└──────────────────────────────────────────────┘
     ↓
┌──────────────────────────────────────────────┐
│ 📝 写代码              最近: 今天 10:30       │ ← 高亮选中
│    [工作 | TimeTracker | 高效]               │
├──────────────────────────────────────────────┤
│ 📝 写文档              最近: 昨天 14:00       │
│    [工作 | CRM | 一般]                        │
├──────────────────────────────────────────────┤
│ 📝 写周报              最近: 上周五           │
│    [工作 | 无 | 一般]                         │
└──────────────────────────────────────────────┘
```

**键盘操作**：
- `↑` `↓` 方向键：在候选列表中移动
- `Enter`：选中当前高亮项
- `Esc`：关闭候选列表
- `Tab`：快速选中第一项

#### 3.3 切换流程

**场景 A：选择历史事项**
```
1. 用户输入"写代码"
2. 自动补全显示候选列表
3. 用户按 Enter（或点击候选项）
4. 弹出维度选择器，自动回填历史维度选项
5. 用户确认（直接 Enter）或修改选项
6. 保存：
   - 结束上一条记录（end_time = 当前时刻）
   - 创建新记录（start_time = 刚才的 end_time，end_time = null）
7. 输入框清空，焦点保持
```

**场景 B：输入新事项**
```
1. 用户输入"整理房间"（历史中没有）
2. 按 Enter
3. 弹出维度选择器，使用默认值（上一条记录的维度选项）
4. 用户选择维度选项
5. 保存逻辑同上
```

---

### 4. 多维标签选择器

#### 4.1 弹窗样式

**触发时机**：
- 用户在快速切换输入框按下 Enter 后
- 用户点击"手动补录时间段"后输入事项名称

**弹窗结构**：
```
┌────────────────────────────────────────────┐
│ 为 "写代码" 选择标签                        │
├────────────────────────────────────────────┤
│ 领域 (必选):                                │
│  ● 工作  ○ 学习  ○ 生活  ○ 娱乐           │
│                                            │
│ 项目 (可选):                                │
│  ○ TimeTracker  ● CRM  ○ 无               │
│                                            │
│ 质量 (可选):                                │
│  ○ 高效  ● 正常  ○ 摸鱼                    │
│                                            │
│  💡 已根据历史记录自动填充                  │
│                                            │
│  [ 取消 (Esc) ]    [ 确认 (Enter) ]        │
└────────────────────────────────────────────┘
```

**样式规范**：
- 弹窗宽度：480px
- 弹窗定位：居中显示
- 背景蒙版：半透明黑色（rgba(0, 0, 0, 0.5)）
- 圆角：16px
- 内边距：32px

#### 4.2 维度显示规则

**维度来源**：
- 读取数据库中 `is_active = true` 的所有维度
- 按 `order` 字段升序排列

**维度展示**：
- 维度名称显示在左侧，后跟 `(必选)` 或 `(可选)` 标识
- 下方水平排列该维度下的所有选项

**选项样式**：
- 单选按钮：圆形（选中态显示实心圆点）
- 选项名称旁边显示颜色标识（小圆点）
- 选中态：蓝色边框 + 蓝色文字
- 未选中态：灰色边框 + 黑色文字

#### 4.3 键盘快捷操作

**快捷键绑定**：
- `Tab` / `Shift+Tab`：在维度之间切换焦点
- `1` `2` `3` ... `9`：快速选择当前维度的第 N 个选项
- `↑` `↓`：在当前维度的选项中移动
- `Space`：选中当前焦点的选项
- `Enter`：确认保存
- `Esc`：取消并关闭弹窗

**提升体验的细节**：
- 焦点默认在第一个维度的第一个选项上
- 数字键操作后自动跳转到下一个维度（连续操作无需 Tab）

#### 4.4 智能默认值

**默认值来源优先级**：
1. **历史事项匹配**：如果事项名称在历史中存在，使用最近一次的维度选项
2. **继承上一条**：如果是全新事项，使用上一条记录的维度选项
3. **系统默认**：如果都没有，使用每个维度的第一个选项

**用户体验**：
- 如果默认值完全正确，用户只需按一次 Enter
- 如果只需修改一个维度，按数字键快速切换后 Enter

---

### 5. 时间流列表

#### 5.1 列表样式

**位置**：在快速切换输入框下方，占据主要内容区域。

**布局方式**：
- 时间轴样式（从上到下）
- 最新的记录在最上面（Now）
- 向下滚动查看更早的记录

**单条记录卡片结构**：
```
┌──────────────────────────────────────────────┐
│ 10:30 - Now   TimeTracker 开发   1h 23m      │
│ [工作 | TimeTracker | 高效]    [✏️] [🗑️]     │
└──────────────────────────────────────────────┘
```

**样式规范**：
- 卡片背景：白色
- 边框：1px 灰色（#E5E7EB）
- 圆角：8px
- 内边距：16px
- 卡片间距：8px
- 悬浮态：背景色变浅蓝（#F0F9FF）

#### 5.2 记录内容显示

**时间段**：
- 格式：`HH:MM - HH:MM` 或 `HH:MM - Now`
- 字号：14px
- 字重：Medium
- 颜色：#1E293B

**事项名称**：
- 字号：16px
- 字重：Medium
- 颜色：#0F172A

**时长**：
- 格式：`Xh Ym`
- 字号：14px
- 颜色：#64748B

**维度标签**：
- 显示方式：水平排列，用 `|` 分隔
- 每个标签显示为：`[维度名:选项名]`
- 使用选项配置的颜色作为标签背景色

#### 5.3 Gap（空洞）展示

**空洞检测逻辑**：
- 当某条记录的 `end_time` ≠ 下一条记录的 `start_time` 时，产生 Gap
- Gap 时长 = 下一条 start_time - 上一条 end_time

**空洞样式**：
```
┌──────────────────────────────────────────────┐
│ 🚫 08:00 - 09:00 (1小时未记录)               │
│ [ 点击补录 ]                                 │
└──────────────────────────────────────────────┘
```

**样式规范**：
- 背景色：浅红色（#FEF2F2）
- 边框：1px 红色虚线（#FCA5A5）
- 图标：警告图标（🚫）
- 提示文字：红色（#DC2626）

**交互行为**：
- 点击空洞区域或"点击补录"按钮
- 弹出快速补录弹窗（预填充时间范围）
- 用户输入事项名称 + 选择维度
- 保存后空洞消失

#### 5.4 操作按钮

**编辑按钮**：
- 图标：✏️
- 功能：弹出编辑弹窗，可修改事项名称、时间、维度标签
- 位置：卡片右上角

**删除按钮**：
- 图标：🗑️
- 功能：弹出确认弹窗，确认后删除记录
- 位置：编辑按钮右侧

**悬浮提示**：
- 鼠标悬浮在按钮上时，显示 Tooltip："编辑" / "删除"

---

### 6. 日期导航栏

#### 6.1 布局位置

**位置**：在"时间流列表"上方，作为列表的头部。

**结构**：
```
┌────────────────────────────────────────────┐
│ 📅 今日记录 (2026-01-03)  [ < 今日 > ]     │
└────────────────────────────────────────────┘
```

#### 6.2 交互逻辑

**左箭头 `<`**：
- 点击：切换到前一天
- 快捷键：`Cmd+[` 或 `Left`

**"今日"按钮**：
- 点击：快速回到今天
- 快捷键：`Cmd+T`

**右箭头 `>`**：
- 点击：切换到后一天（如果不是今天）
- 如果已经是今天，右箭头置灰不可点击

**日期显示**：
- 点击日期文字：弹出日期选择器，可跳转到任意日期
- 格式：`YYYY-MM-DD`
- 特殊标识：
  - 今天：`(今日)`
  - 昨天：`(昨日)`
  - 其他：显示星期几（如：`(周三)`）

---

### 7. 手动补录时间段

#### 7.1 入口位置

**位置**：在时间流列表的底部。

**按钮样式**：
```
┌────────────────────────────────────────────┐
│ [ + 手动补录时间段 ]                        │
└────────────────────────────────────────────┘
```

**样式规范**：
- 按钮宽度：100%
- 高度：40px
- 边框：1px 虚线灰色（#D1D5DB）
- 背景色：透明
- 文字颜色：蓝色（#3B82F6）
- 悬浮态：背景色浅蓝（#EFF6FF）

#### 7.2 补录弹窗

**弹窗结构**：
```
┌────────────────────────────────────────────┐
│ 补录时间段                                  │
├────────────────────────────────────────────┤
│ 日期:                                      │
│  [2026-01-03]  ← 日期选择器                │
│                                            │
│ 时间范围:                                   │
│  [09:00] - [10:30]                         │
│                                            │
│ 事项名称:                                   │
│  [写代码________]  ← 支持自动补全           │
│                                            │
│ 维度标签:                                   │
│  [领域: 工作 ▼]  [项目: TT ▼]  [质量: 高效 ▼]│
│                                            │
│  [ 取消 ]              [ 保存 (Cmd+S) ]    │
└────────────────────────────────────────────┘
```

#### 7.3 字段说明

**日期字段**：
- 默认值：当前查看的日期
- 可修改：点击弹出日期选择器

**时间范围**：
- 开始时间和结束时间都必填
- 支持键盘输入：`0900` 自动解析为 `09:00`
- 校验逻辑：结束时间 > 开始时间

**事项名称**：
- 支持历史事项自动补全（逻辑同快速切换输入框）
- 当输入历史事项时，自动回填维度标签

**维度标签**：
- 展示所有已启用的维度
- 每个维度为一个下拉选择器
- 支持智能默认

#### 7.4 时间冲突检测

**检测逻辑**：
- 保存前查询同一日期下是否有时间段重叠
- 重叠定义：
  ```
  (new_start < existing_end) AND (new_end > existing_start)
  ```

**冲突处理**：
- 如果检测到冲突，弹出警告提示：
  ```
  ⚠️ 时间段冲突
  
  09:00 - 10:30 与以下记录重叠:
  - 09:30 - 11:00  开会 [工作]
  
  是否仍要保存?
  [ 取消 ]  [ 仍然保存 ]
  ```
- 用户可以选择"仍然保存"（适用于多任务并行场景）

---

### 8. 全局快捷键

#### 8.1 快捷键清单

| 快捷键 | 功能 | 适用场景 |
|--------|------|---------|
| `Cmd+K` | 聚焦到快速切换输入框 | 全局 |
| `Cmd+N` | 打开手动补录弹窗 | 全局 |
| `Cmd+T` | 回到今天 | 日期导航 |
| `Cmd+[` | 前一天 | 日期导航 |
| `Cmd+]` | 后一天 | 日期导航 |
| `Cmd+E` | 编辑当前正在进行的事项 | 有正在进行的记录时 |
| `Cmd+Enter` | 快速确认（维度选择器） | 维度选择器弹窗中 |
| `Esc` | 关闭弹窗 | 任意弹窗中 |

#### 8.2 快捷键优先级

**冲突处理**：
- 如果有弹窗打开，弹窗内快捷键优先级高于全局快捷键
- 如果输入框有焦点，输入事件优先于快捷键

---

## 技术实现

### 1. 数据流设计

#### 1.1 状态管理（Zustand Store）

**时间记录状态**：
```typescript
interface TimeEntriesState {
  // 当前正在进行的记录（end_time 为 null）
  currentEntry: TimeEntry | null;
  
  // 当前查看日期的所有记录
  entries: TimeEntry[];
  
  // 当前查看的日期
  currentDate: string; // YYYY-MM-DD
  
  // 检测到的空洞列表
  gaps: Gap[];
  
  // Actions
  switchActivity: (title: string, dimensions: DimensionSelection[]) => Promise<void>;
  loadEntries: (date: string) => Promise<void>;
  updateEntry: (id: number, data: Partial<TimeEntry>) => Promise<void>;
  deleteEntry: (id: number) => Promise<void>;
  fillGap: (gap: Gap, entry: CreateTimeEntryInput) => Promise<void>;
}
```

**类型定义**：
```typescript
interface TimeEntry {
  id: number;
  title: string;
  start_time: string; // ISO 8601 格式，秒级精度，如 '2026-01-03T09:00:15'
  end_time: string | null; // NULL 表示正在进行中
  duration_seconds: number; // 时长（秒），如 5430 表示 90.5 分钟
  description?: string;
  created_at: string;
  
  // 关联的维度选项
  dimensions: {
    dimension_id: number;
    dimension_name: string;
    option_id: number;
    option_name: string;
    option_color: string;
  }[];
}

interface Gap {
  start_time: string;
  end_time: string;
  duration_seconds: number; // 秒级精度
}

interface DimensionSelection {
  dimension_id: number;
  option_id: number;
}
```

#### 1.2 IPC 通信接口

**主进程 API**：
  ```typescript
// 切换活动（核心操作）
ipcMain.handle('time-entries:switch', async (event, data: {
  title: string;
  dimensions: DimensionSelection[];
}) => {
  // 1. 结束当前正在进行的记录（如果有）
  // 2. 创建新记录（start_time = now, end_time = null）
  // 3. 关联维度选项
  // 4. 返回新记录和更新后的当前记录
});

// 获取指定日期的记录列表
ipcMain.handle('time-entries:list', async (event, date: string) => {
  // 返回该日期的所有记录 + 检测到的空洞
});

// 获取当前正在进行的记录
ipcMain.handle('time-entries:current', async () => {
  // 返回 end_time 为 null 的记录
});

// 手动补录
ipcMain.handle('time-entries:create-manual', async (event, data: {
  date: string;
  start_time: string;
  end_time: string;
  title: string;
  dimensions: DimensionSelection[];
}) => {
  // 创建记录 + 时间冲突检测
});

// 填补空洞
ipcMain.handle('time-entries:fill-gap', async (event, data: {
  start_time: string;
  end_time: string;
  title: string;
  dimensions: DimensionSelection[];
}) => {
  // 创建记录填补空洞
});

// 更新记录
ipcMain.handle('time-entries:update', async (event, id: number, data: Partial<TimeEntry>) => {
  // 更新记录 + 重新计算空洞
});

// 删除记录
ipcMain.handle('time-entries:delete', async (event, id: number) => {
  // 删除记录 + 检测是否产生新空洞
});
```

#### 1.3 数据库操作

**切换活动（核心 SQL）**：
```sql
-- 1. 结束当前正在进行的记录
UPDATE time_entries
SET 
  end_time = datetime('now', 'localtime'),
  duration_seconds = CAST((julianday(datetime('now', 'localtime')) - julianday(start_time)) * 86400 AS INTEGER)
WHERE end_time IS NULL;

-- 2. 创建新记录
INSERT INTO time_entries (title, start_time, end_time, duration_seconds)
VALUES (?, datetime('now', 'localtime'), NULL, 0);

-- 3. 关联维度选项（批量插入）
INSERT INTO entry_attributes (entry_id, option_id)
VALUES (?, ?), (?, ?), ...;

-- 注：编辑记录的维度选项时，采用"先删后插"策略
-- DELETE FROM entry_attributes WHERE entry_id = ?;
-- 然后重新插入新的关联
```

**空洞检测算法**：
```typescript
function detectGaps(entries: TimeEntry[]): Gap[] {
  const gaps: Gap[] = [];
  
  // 按时间正序排序
  const sorted = entries.sort((a, b) => 
    new Date(a.start_time).getTime() - new Date(b.start_time).getTime()
  );
  
  for (let i = 0; i < sorted.length - 1; i++) {
    const current = sorted[i];
    const next = sorted[i + 1];
    
    // 如果当前记录的结束时间 < 下一条的开始时间，产生空洞
    if (current.end_time && current.end_time < next.start_time) {
      const startMs = new Date(current.end_time).getTime();
      const endMs = new Date(next.start_time).getTime();
      const durationSeconds = Math.floor((endMs - startMs) / 1000);
      
      gaps.push({
        start_time: current.end_time,
        end_time: next.start_time,
        duration_seconds: durationSeconds
      });
    }
  }
  
  return gaps;
}
```

### 2. 智能默认实现

#### 2.1 历史事项匹配

**SQL 查询**：
```sql
-- 查询某个事项名称最近一次使用的维度选项
SELECT 
  ea.option_id,
  o.dimension_id,
  d.name AS dimension_name,
  o.name AS option_name
FROM time_entries te
JOIN entry_attributes ea ON te.id = ea.entry_id
JOIN dimension_options o ON ea.option_id = o.id
JOIN dimensions d ON o.dimension_id = d.id
WHERE te.title = ?
ORDER BY te.start_time DESC
LIMIT 1;
```

#### 2.2 自动补全实现

**模糊搜索 SQL**：
```sql
-- 前缀匹配 + 包含匹配
SELECT DISTINCT
  title,
  MAX(start_time) AS last_used
FROM time_entries
WHERE title LIKE ? OR title LIKE ?
GROUP BY title
ORDER BY last_used DESC
LIMIT 10;
```

**TypeScript 逻辑**：
```typescript
async function getAutocompleteSuggestions(input: string): Promise<Suggestion[]> {
  const prefix = `${input}%`;
  const contains = `%${input}%`;
  
  const results = await db.all(
    `SELECT DISTINCT title, MAX(start_time) AS last_used
     FROM time_entries
     WHERE title LIKE ? OR title LIKE ?
     GROUP BY title
     ORDER BY last_used DESC
     LIMIT 10`,
    [prefix, contains]
  );
  
  // 为每个结果附加维度选项
  const suggestions = await Promise.all(
    results.map(async (r) => ({
      title: r.title,
      lastUsed: r.last_used,
      dimensions: await getLastDimensionsForTitle(r.title)
    }))
  );
  
  return suggestions;
}
```

### 3. 性能优化

#### 3.1 数据库索引

```sql
-- 时间记录表索引
CREATE INDEX idx_time_entries_date ON time_entries(DATE(start_time));
CREATE INDEX idx_time_entries_end_time ON time_entries(end_time);
CREATE INDEX idx_time_entries_title ON time_entries(title);

-- 关联表索引
CREATE INDEX idx_entry_attributes_entry ON entry_attributes(entry_id);
CREATE INDEX idx_entry_attributes_option ON entry_attributes(option_id);
```

#### 3.2 缓存策略

**当前记录缓存**：
- 应用启动时加载一次 `end_time = null` 的记录
- 切换活动时更新缓存
- 编辑/删除时更新缓存

**时长更新策略**：
- 使用 `setInterval` 每分钟更新一次"已持续"时长
- 不使用秒级刷新（降低 CPU 占用）

#### 3.3 虚拟列表

**适用场景**：
- 当查看某一天的记录超过 50 条时
- 使用 `react-window` 实现虚拟滚动

---

## 验收标准

### 1. 功能验收

| 功能点 | 验收标准 | 优先级 |
|--------|---------|--------|
| 时间切换 | 输入事项名称 + 回车，成功结束上一条并开始新记录 | P0 |
| 智能默认 | 输入历史事项，自动回填维度选项准确率 100% | P0 |
| 空洞检测 | 修改历史记录后，正确检测并高亮显示空洞 | P0 |
| 自动补全 | 输入 ≥ 2 个字符，显示候选列表（响应时间 < 200ms） | P0 |
| 键盘操作 | 全流程可纯键盘完成，无需鼠标 | P0 |
| 日期导航 | 左右箭头切换日期，正确加载对应日期的记录 | P1 |
| 手动补录 | 可补录任意历史时间段，时间冲突检测准确 | P1 |

### 2. 性能验收

| 指标 | 目标值 | 测试场景 |
|------|--------|---------|
| 切换响应时间 | < 300ms | 从输入事项到保存完成 |
| 自动补全响应 | < 200ms | 输入字符到显示候选列表 |
| 列表渲染时间 | < 500ms | 加载 100 条记录 |
| 空洞检测时间 | < 100ms | 检测 100 条记录中的空洞 |
| 内存占用 | < 200MB | 长期运行（8 小时） |

### 3. 用户体验验收

| 体验指标 | 验收标准 | 测试方法 |
|---------|---------|---------|
| 录入速度 | 单次切换 < 3 秒（含思考） | 实际使用测试 |
| 键盘流畅度 | 全程无需鼠标操作 | 盲操测试 |
| 视觉清晰度 | 空洞和正常记录能明显区分 | 视觉审查 |
| 错误容忍度 | 忘记切换可快速补救 | 异常场景测试 |

---

## 边界情况处理

### 1. 系统休眠

**场景**：用户合上电脑，系统进入休眠。

**处理逻辑**：
1. 应用恢复后，检测系统时间差
2. 如果时间差 > 5 分钟，弹出提示：
   ```
   ⚠️ 检测到系统休眠
   
   休眠时段：14:30 - 15:45 (1h 15m)
   当前正在进行：写代码
   
   是否将休眠时段计入 "写代码"？
   [ 否，结束记录 ]  [ 是，继续计时 ]
   ```

### 2. 跨天连续

**场景**：用户从 23:30 工作到 00:30（跨天）。

**处理逻辑**：
- 在 00:00 时自动分割记录：
  - 记录1：23:30 - 23:59:59 (29分钟) 日期:昨天
  - 记录2：00:00:00 - 00:30 (30分钟) 日期:今天
- 两条记录的事项名称和维度标签相同

### 3. 首次使用

**场景**：用户首次打开应用，数据库为空。

**处理逻辑**：
- 显示欢迎引导：
  ```
  👋 欢迎使用 TimeTracker
  
  让我们开始记录你的第一个时间段吧！
  
  [ 开始新的一天 ]
  ```
- 点击后，聚焦到快速切换输入框
- 提供示例操作动画

### 4. 长时间未切换

**场景**：用户上午 9:00 开始"写代码"，下午 5:00 才想起来切换。

**处理逻辑**：
- 不弹出警告（避免打扰）
- 用户切换时，"写代码"记录时长显示为 8 小时
- 如果用户发现不对，点击编辑修正结束时间
- 修正后系统自动检测到空洞，提示补录

---

## 未来迭代方向

### V3.1 增强功能

1. **自然语言输入**
   - 支持：`-2h 午睡` → 系统理解为"从现在往前倒推2小时记录午睡"
   - 支持：`1400-1530 开会 [工作]` → 解析为完整记录

2. **智能时间建议**
   - 分析用户习惯，在特定时间点主动提示：
     - "现在是 12:00，是否切换到午餐？"

3. **批量补录**
   - 如果一天结束有多个空洞，提供"批量补录"界面
   - 一次性填补所有空洞

### V3.2 高级分析

1. **维度交叉分析**
   - 如："工作"领域下，各"项目"的时长分布
   - 如："高效"质量的时段，主要在做哪些事项

2. **时间黑洞识别**
   - 自动识别"摸鱼"时段过多的日子
   - 标记异常时间分配

---

**文档版本**：v3.0
**最后更新**：2026-01-03
**核心变更**：从"计时器"重构为"时间切分器"，引入多维标签系统
